<!-- Cabeza / Navbar include (inline JS, sem arquivo externo) -->
<nav class="navbar" id="navbar" aria-label="Navegación principal">
  <ul class="nav-list" id="navList" role="menubar">
    <li class="nav-item has-dropdown active" data-idx="0" role="none">
      <a class="nav-link" href="{{ '/' | relative_url }}" role="menuitem" aria-haspopup="true" aria-expanded="false">
        Inicio <span class="caret" aria-hidden="true"></span>
      </a>
      <div class="popover" role="menu" aria-label="Inicio">
        <ul>
          <li><a href="{{ '/#conoce' | relative_url }}" role="menuitem">Conoce el curso</a></li>
          <li><a href="{{ '/#eventos' | relative_url }}" role="menuitem">Eventos</a></li>
          <li><a href="{{ '/#materiales' | relative_url }}" role="menuitem">Materiales</a></li>
        </ul>
      </div>
    </li>

    <li class="nav-item has-dropdown" data-idx="1" role="none">
      <a class="nav-link" href="{{ '/alumno/' | relative_url }}" role="menuitem" aria-haspopup="true" aria-expanded="false">
        Alumno <span class="caret" aria-hidden="true"></span>
      </a>
      <div class="popover" role="menu" aria-label="Alumno">
        <ul>
          <li><a href="{{ '/alumno/ejercicios/' | relative_url }}" role="menuitem">Ejercicios</a></li>
          <li><a href="{{ '/alumno/pruebas/' | relative_url }}" role="menuitem">Pruebas</a></li>
          <li><a href="{{ '/alumno/materiales/' | relative_url }}" role="menuitem">Materiales</a></li>
        </ul>
      </div>
    </li>

    <li class="nav-item has-dropdown" data-idx="2" role="none">
      <a class="nav-link" href="{{ '/profesor/' | relative_url }}" role="menuitem" aria-haspopup="true" aria-expanded="false">
        Profesor <span class="caret" aria-hidden="true"></span>
      </a>
      <div class="popover" role="menu" aria-label="Profesor">
        <ul>
          <li><a href="{{ '/profesor/libros/' | relative_url }}" role="menuitem">Libros</a></li>
          <li><a href="{{ '/profesor/guias/' | relative_url }}" role="menuitem">Guías</a></li>
          <li><a href="{{ '/profesor/asistencia/' | relative_url }}" role="menuitem">Asistencia</a></li>
        </ul>
      </div>
    </li>

    <li class="nav-item has-dropdown" data-idx="3" role="none">
      <a class="nav-link" href="{{ '/contactos/' | relative_url }}" role="menuitem" aria-haspopup="true" aria-expanded="false">
        Contacto <span class="caret" aria-hidden="true"></span>
      </a>
      <div class="popover" role="menu" aria-label="Contacto">
        <ul>
          <li><a href="{{ '/contactos/agendar/' | relative_url }}" role="menuitem">Agendar citas</a></li>
          <li><a href="{{ '/contactos/dudas/' | relative_url }}" role="menuitem">Dudas</a></li>
          <li><a href="{{ '/contactos/test/' | relative_url }}" role="menuitem">Test de nivel</a></li>
        </ul>
      </div>
    </li>
  </ul>
  <span class="nav-underline" id="navUnderline" aria-hidden="true"></span>
</nav>

<script>
(function(){
  const nav = document.getElementById('navbar');
  if(!nav) return;
  const ul = nav.querySelector('#navList');
  const underline = nav.querySelector('#navUnderline');

  function placeUnderlineTo(li, instant=false){
    if(!underline || !li) return;
    const navRect = nav.getBoundingClientRect();
    const liRect  = li.getBoundingClientRect();
    const left = liRect.left - navRect.left;
    const width = liRect.width;
    if(instant){
      const old = underline.style.transition;
      underline.style.transition = 'none';
      underline.style.left = left + 'px';
      underline.style.width = width + 'px';
      void underline.offsetWidth;
      underline.style.transition = old || 'left .15s,width .15s';
      return;
    }
    underline.style.left = left + 'px';
    underline.style.width = width + 'px';
  }

  function setActive(li){
    ul.querySelectorAll('.nav-item').forEach(it=>it.classList.toggle('active', it===li));
  }

  function closeAll(){
    ul.querySelectorAll('.has-dropdown.open').forEach(li=>li.classList.remove('open'));
  }

  ul.addEventListener('click', e=>{
    const link = e.target.closest('.nav-link');
    if(!link) return;
    const li = link.closest('.nav-item');

    if(li.classList.contains('has-dropdown')){
      e.preventDefault();
      const open = li.classList.toggle('open');
      ul.querySelectorAll('.has-dropdown').forEach(o=>{ if(o!==li) o.classList.remove('open'); });
      setActive(li);
      placeUnderlineTo(li);
      link.setAttribute('aria-expanded', String(open));
      return;
    }
    setActive(li);
    placeUnderlineTo(li);
  }, {passive:false});

  document.addEventListener('click', e=>{ if(!nav.contains(e.target)) closeAll(); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeAll(); });

  function init(){
    const li = ul.querySelector('.nav-item.active') || ul.querySelector('.nav-item');
    if(li) placeUnderlineTo(li, true);
  }
  window.addEventListener('load', init);
  window.addEventListener('resize', ()=>init());
})();
</script>
