<div class="top-bar" aria-hidden="true"></div>
<a href="{{ '/' | relative_url }}" class="logo-link" aria-label="Inicio">
  <img class="logo" src="{{ '/inicial/a03.gif' | relative_url }}" alt="Cultura Hispánica">
</a>

<div class="menu-slot">
  <nav class="navbar" id="navbar">
    <ul class="nav-list" id="navList">
      <li class="nav-item has-dropdown" data-idx="0">
        <a class="nav-link" href="{{ '/guias/inicio.html' | relative_url }}">Inicio <span class="caret"></span></a>
        <div class="popover" role="menu"><ul>
          <li><a href="{{ '/guias/conoce_el_curso.html' | relative_url }}" role="menuitem">Conoce el curso</a></li>
          <li><a href="{{ '/guias/eventos.html' | relative_url }}" role="menuitem">Eventos</a></li>
          <li><a href="{{ '/guias/materiales.html' | relative_url }}" role="menuitem">Materiales</a></li>
        </ul></div>
      </li>
      <li class="nav-item has-dropdown" data-idx="1">
        <a class="nav-link" href="{{ '/guias/alumno.html' | relative_url }}">Alumno <span class="caret"></span></a>
        <div class="popover" role="menu"><ul>
          <li><a href="{{ '/guias/ejercicios.html' | relative_url }}" role="menuitem">Ejercicios</a></li>
          <li><a href="{{ '/guias/pruebas.html' | relative_url }}" role="menuitem">Pruebas</a></li>
          <li><a href="{{ '/guias/archivos.html' | relative_url }}" role="menuitem">Archivos</a></li>
        </ul></div>
      </li>
      <li class="nav-item has-dropdown" data-idx="2">
        <a class="nav-link" href="{{ '/guias/profesor.html' | relative_url }}">Profesor <span class="caret"></span></a>
        <div class="popover" role="menu"><ul>
          <li><a href="{{ '/guias/libros.html' | relative_url }}" role="menuitem">Libros</a></li>
          <li><a href="{{ '/guias/guias.html' | relative_url }}" role="menuitem">Guías</a></li>
          <li><a href="{{ '/guias/asistencia.html' | relative_url }}" role="menuitem">Asistencia</a></li>
        </ul></div>
      </li>
      <li class="nav-item has-dropdown" data-idx="3">
        <a class="nav-link" href="{{ '/guias/contacto.html' | relative_url }}">Contacto <span class="caret"></span></a>
        <div class="popover" role="menu"><ul>
          <li><a href="{{ '/guias/agendar_citas.html' | relative_url }}" role="menuitem">Agendar citas</a></li>
          <li><a href="{{ '/guias/dudas.html' | relative_url }}" role="menuitem">Dudas</a></li>
          <li><a href="{{ '/guias/test_de_nivel.html' | relative_url }}" role="menuitem">Test de nivel</a></li>
        </ul></div>
      </li>
    </ul>
    <span class="nav-underline" id="navUnderline"></span>
  </nav>
</div>

<div class="account" aria-label="acceder">
  <div class="avatar" aria-hidden="true"></div>
  <div class="acc-label">acceder</div>
</div>

<script>
(function(){
  const nav = document.getElementById('navbar');
  const ul  = document.getElementById('navList');
  const underline = document.getElementById('navUnderline');

  function setUnderline(li, instant=false){
    const c = nav.getBoundingClientRect();
    const r = li.getBoundingClientRect();
    const left  = r.left - c.left;
    const width = r.width;

    if (instant){
      const t = underline.style.transition;
      underline.style.transition = 'none';
      underline.style.left  = left  + 'px';
      underline.style.width = width + 'px';
      void underline.offsetWidth;
      underline.style.transition = t || 'left .15s,width .15s';
      return;
    }

    const a  = ul.querySelector('.nav-item.active') || li;
    const fr = a.getBoundingClientRect();
    const fl = fr.left - c.left;
    const frt= fl + fr.width;
    const tl = left;
    const tr = left + width;

    underline.style.transition = 'left .15s,width .15s';
    if (tl > fl){
      underline.style.left  = fl + 'px';
      underline.style.width = (tr - fl) + 'px';
      setTimeout(() => {
        underline.style.left  = tl + 'px';
        underline.style.width = width + 'px';
      }, 170);
    } else {
      underline.style.left  = tl + 'px';
      underline.style.width = (frt - tl) + 'px';
      setTimeout(() => {
        underline.style.width = width + 'px';
      }, 170);
    }
  }

  function closeAll(){ ul.querySelectorAll('.has-dropdown.open').forEach(li => li.classList.remove('open')); }

  ul.addEventListener('click', (e) => {
    const link = e.target.closest('.nav-link');
    if (!link) return;

    const li = link.closest('.nav-item');

    if (li.classList.contains('has-dropdown')){
      e.preventDefault();
      li.classList.toggle('open');
      ul.querySelectorAll('.has-dropdown').forEach(o => { if (o !== li) o.classList.remove('open'); });
      ul.querySelectorAll('.nav-item').forEach(it => it.classList.toggle('active', it === li));
      setUnderline(li);
      return;
    } else {
      closeAll();
    }

    ul.querySelectorAll('.nav-item').forEach(it => it.classList.toggle('active', it === li));
    setUnderline(li);
  });

  document.addEventListener('click', (e) => { if (!nav.contains(e.target)) closeAll(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });

  window.addEventListener('load', () => {
    const active = ul.querySelector('.nav-item.active') || ul.querySelector('.nav-item');
    setUnderline(active, true);
  });
  window.addEventListener('resize', () => {
    const active = ul.querySelector('.nav-item.active') || ul.querySelector('.nav-item');
    setUnderline(active, true);
  });
})();
</script>
