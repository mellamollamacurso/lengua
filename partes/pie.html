<!-- partes/pie.html (contadores com multi-fallback e sombra intacta no layout) -->
<footer class="footer-strip">
  <img class="avatar" src="https://mellamollamacurso.github.io/lengua/inicial/a05.png" alt="avatar del profe" />
  <div class="footer-texts">
    <div class="footer-line1">Profe : Álex Barges</div>
    <div class="footer-sub">profesor y creador</div>
    <div class="footer-line2">
      <div class="course-name">Curso Cultura Hispánica</div>
      <div class="version-badge">v0.29</div>
    </div>
    <div class="footer-legal">todos los derechos reservados</div>
  </div>

  <div id="llama-stats" aria-live="polite">
    <span>total de llamas: <span class="val" id="stat-total">—</span></span>
    <span style="margin-left:24px">llamas conectadas: <span class="val" id="stat-online">—</span></span>
  </div>
</footer>

<script>
(function(){
  const elTotal  = document.getElementById('stat-total');
  const elOnline = document.getElementById('stat-online');
  if(!elTotal || !elOnline) return;

  const NS = 'mellamollamacurso_github_io_portal';
  const fmt = n => (n==null || isNaN(n)) ? '—' : new Intl.NumberFormat('es-ES').format(n);

  const DIRECT = (path) => `https://api.countapi.xyz/${path}`;
  const AORIG  = (path) => `https://api.allorigins.win/get?disableCache=true&url=${encodeURIComponent(DIRECT(path))}`;
  const CODETB = (path) => `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(DIRECT(path))}`;
  const JINAA  = (path) => `https://r.jina.ai/http://api.countapi.xyz/${path}`;

  async function tryFetch(url, parseWrapped=false){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw 0;
    const t = await r.text();
    if(parseWrapped){
      try { const j = JSON.parse(t); if(j && j.contents) return JSON.parse(j.contents); } catch(e){}
      try { return JSON.parse(t); } catch(e){}
      throw 0;
    }
    try { return JSON.parse(t); } catch(e){ throw 0; }
  }

  async function getCount(path){
    // cadeia de fallbacks: direta -> allorigins -> codetabs -> jina
    try { return await tryFetch(DIRECT(path)); } catch(e){}
    try { return await tryFetch(AORIG(path), true); } catch(e){}
    try { return await tryFetch(CODETB(path)); } catch(e){}
    try { return await tryFetch(JINAA(path)); } catch(e){}
    throw 0;
  }

  async function init(){
    if(!navigator.onLine){ elTotal.textContent = elOnline.textContent = '—'; return; }

    try{ await getCount(`create/${NS}/online?value=0`); }catch(e){}

    try{
      const total = await getCount(`hit/${NS}/visits`);
      elTotal.textContent = fmt(total.value||0);
    }catch(e){ elTotal.textContent = '—'; }

    try{
      await getCount(`update/${NS}/online?amount=1`);
      const online = await getCount(`get/${NS}/online`);
      elOnline.textContent = fmt(online.value||0);
    }catch(e){ elOnline.textContent = '—'; }

    setInterval(async ()=>{
      if(!navigator.onLine) return;
      try{
        const online = await getCount(`get/${NS}/online`);
        elOnline.textContent = fmt(online.value||0);
      }catch(e){}
    }, 15000);
  }

  window.addEventListener('beforeunload', ()=>{
    try{ navigator.sendBeacon(DIRECT(`update/${NS}/online?amount=-1`)); }catch(e){}
  });
  window.addEventListener('online', init);
  window.addEventListener('load', init);
})();
</script>
