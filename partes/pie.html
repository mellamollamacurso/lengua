<footer class="footer-strip">
  <img class="avatar" src="https://mellamollamacurso.github.io/lengua/inicial/a05.png" alt="avatar del profe" />
  <div class="footer-texts">
    <div class="footer-line1">Profe : Álex Barges</div>
    <div class="footer-sub">profesor y creador</div>
    <div class="footer-line2">
      <div class="course-name">Curso Cultura Hispánica</div>
      <div class="version-badge" aria-label="versión del sitio">v—</div>
    </div>
    <div class="footer-legal">todos los derechos reservados</div>
  </div>

  <div id="llama-stats" aria-live="polite">
    <span>total de llamas: <span class="val" id="stat-total">—</span></span>
    <span style="margin-left:24px">llamas en línea: <span class="val" id="stat-online">—</span></span>
  </div>
</footer>

<script>
(async () => {
  // ====== Versión automática (Pages Function /api/version) ======
  const el = document.querySelector('.version-badge');
  if (el) {
    try {
      const r = await fetch('/api/version', { cache: 'no-store' });
      el.textContent = r.ok ? (await r.text()).trim() || 'v—' : 'v—';
    } catch { el.textContent = 'v—'; }
  }

  // ====== Contadores (Cloudflare Worker) ======
  const elTotal  = document.getElementById('stat-total');
  const elOnline = document.getElementById('stat-online');
  if (!elTotal || !elOnline) return;

  const API = 'https://mellamollama-contadores.mellamollamacurso.workers.dev';
  const fmt = n => (n==null || isNaN(n)) ? '—' : new Intl.NumberFormat('es-ES').format(n);

  async function jget(path, opts){
    const r = await fetch(API + path, Object.assign({ cache:'no-store', mode:'cors' }, opts || {}));
    if(!r.ok) throw new Error('http ' + r.status);
    return await r.json();
  }

  async function init(){
    try{
      const t = await jget('/visits');
      elTotal.textContent = fmt(t.value || 0);
    }catch{ elTotal.textContent = '—'; }

    try{
      await jget('/online/in', { method:'POST', keepalive:true });
      const on = await jget('/online');
      elOnline.textContent = fmt(on.value || 0);
    }catch{ elOnline.textContent = '—'; }

    setInterval(async ()=>{
      try{
        const on = await jget('/online');
        elOnline.textContent = fmt(on.value || 0);
      }catch{}
    }, 15000);
  }

  window.addEventListener('beforeunload', ()=>{
    try{ navigator.sendBeacon(API + '/online/out'); }catch{}
  });
  window.addEventListener('load', init);
})();
</script>
